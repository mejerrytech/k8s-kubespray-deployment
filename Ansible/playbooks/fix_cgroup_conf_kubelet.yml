---
- name: Fix Kubelet Cgroup Configuration
  hosts: k8s_cluster
  become: true
  serial: 1                        # ‚Üê Process one node at a time
  gather_facts: true
  vars:
    kubelet_service_path: /etc/systemd/system/kubelet.service

  tasks:
    - name: Check if kubelet.service exists
      stat:
        path: "{{ kubelet_service_path }}"
      register: kubelet_service_file_stat

    - name: Skip if kubelet.service doesn't exist
      debug:
        msg: "kubelet.service not found, skipping node {{ inventory_hostname }}"
      when: not kubelet_service_file_stat.stat.exists

    - name: Ensure CPUAccounting line exists under [Service]
      lineinfile:
        path: "{{ kubelet_service_path }}"
        regexp: '^CPUAccounting='
        line: 'CPUAccounting=true'
        insertafter: '^\[Service\]$'
        backup: yes
      when: kubelet_service_file_stat.stat.exists

    - name: Ensure MemoryAccounting line exists under [Service]
      lineinfile:
        path: "{{ kubelet_service_path }}"
        regexp: '^MemoryAccounting='
        line: 'MemoryAccounting=true'
        insertafter: '^\[Service\]$'
        backup: yes
      when: kubelet_service_file_stat.stat.exists

    - name: Reload systemd to apply unit file changes
      systemd:
        daemon_reload: true
      when: kubelet_service_file_stat.stat.exists

    - name: Restart kubelet service
      systemd:
        name: kubelet
        state: restarted
        daemon_reload: true
      when: kubelet_service_file_stat.stat.exists

    - name: Wait for kubelet to stabilize
      pause:
        seconds: 10
      when: kubelet_service_file_stat.stat.exists

    # ============================================
    # CHECK THIS NODE AFTER ITS RESTART
    # ============================================
    - name: Wait for this node to become Ready
      shell: kubectl get node {{ inventory_hostname }} --no-headers --kubeconfig=/etc/kubernetes/admin.conf | awk '{print $2}'
      register: node_status
      until: node_status.stdout == "Ready"
      retries: 12
      delay: 5
      delegate_to: "{{ groups['kube_control_plane'][0] }}"
      when: kubelet_service_file_stat.stat.exists
      changed_when: false
      failed_when: false

    - name: Display node status after restart
      debug:
        msg: "Node {{ inventory_hostname }} status: {{ node_status.stdout | default('Unknown') }}"
      when: 
        - kubelet_service_file_stat.stat.exists
        - node_status is defined

# ============================================
# FINAL VERIFICATION (ALL NODES)
# ============================================
- name: Verify All Nodes
  hosts: kube_control_plane[0]
  become: true
  gather_facts: false
  vars:
    kubectl_bin: /usr/local/bin/kubectl
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

  tasks:
    - name: Get all nodes status
      shell: "{{ kubectl_bin }} get nodes --no-headers --kubeconfig=/etc/kubernetes/admin.conf | awk '$2 ~ /^Ready/ {c++} END{print c+0}'"
      register: ready_nodes
      changed_when: false
      failed_when: false

    - name: Debug ready nodes count
      debug:
        msg: "Ready nodes: {{ ready_nodes.stdout | default('N/A') }}/{{ groups['k8s_cluster'] | length }}"

    - name: Get final node status
      command: "{{ kubectl_bin }} get nodes -o wide --kubeconfig=/etc/kubernetes/admin.conf"
      register: node_status
      changed_when: false
      failed_when: false

    - name: Debug final node status
      debug:
        msg: "{{ node_status.stdout_lines | default(['Unable to get node status']) }}"
      when: 
        - node_status is defined
        - node_status.stdout_lines is defined

    - name: Check if all nodes are ready
      set_fact:
        all_nodes_ready: "{{ ready_nodes.stdout | int == groups['k8s_cluster'] | length }}"
      when: 
        - ready_nodes is defined
        - ready_nodes.stdout is defined

    - name: Display final status
      debug:
        msg:
          - "========================================="
          - "Cgroup Configuration Complete"
          - "========================================="
          - "Ready Nodes: {{ ready_nodes.stdout | default('N/A') }}/{{ groups['k8s_cluster'] | length }}"
          - "Status: {{ 'All nodes ready' if (all_nodes_ready | default(false)) else 'Some nodes may not be ready yet' }}"
          - ""
          - "========================================="
      
    - name: Display node details
      debug:
        msg: "{{ node_status.stdout_lines }}"
      when: 
        - node_status is defined
        - node_status.stdout_lines is defined