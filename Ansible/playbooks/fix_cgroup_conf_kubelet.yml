---
# ==============================================================================
# POST-DEPLOYMENT MASTER AND NODE CGROUP FIX PLAYBOOK
# ==============================================================================
# Automatically fixes all kubernetes servers kubelet configuration to add cgroup configurations
# This playbook updates all nodes dynamically.
# ==============================================================================

- name: Fix Worker Node Kubelet Configuration
  hosts: k8s_cluster
  become: true
  gather_facts: true
  vars:
    kubelet_service_path: /etc/systemd/system/kubelet.service

  tasks:
    - name: Check if kubelet.service exists
      stat:
        path: "{{ kubelet_service_path }}"
      register: kubelet_service_file_stat

    - name: Skip if kubelet.service doesn't exist
      debug:
        msg: "kubelet.service not found, skipping node {{ inventory_hostname }}"
      when: not kubelet_service_file_stat.stat.exists

    - name: Ensure CPUAccounting line exists under [Service]
      lineinfile:
        path: "{{ kubelet_service_path }}"
        regexp: '^CPUAccounting='
        line: 'CPUAccounting=true'
        insertafter: '^\[Service\]$'
        backup: yes
      when: kubelet_service_file_stat.stat.exists

    - name: Ensure MemoryAccounting line exists under [Service]
      lineinfile:
        path: "{{ kubelet_service_path }}"
        regexp: '^MemoryAccounting='
        line: 'MemoryAccounting=true'
        insertafter: '^\[Service\]$'
        backup: yes
      when: kubelet_service_file_stat.stat.exists

    - name: Reload systemd to apply unit file changes
      systemd:
        daemon_reload: true
      when: kubelet_service_file_stat.stat.exists

    - name: Restart kubelet service
      systemd:
        name: kubelet
        state: restarted
        daemon_reload: true
      when: kubelet_service_file_stat.stat.exists

    - name: Wait for kubelet to stabilize
      pause:
        seconds: 5
      when: kubelet_service_file_stat.stat.exists

- name: Verify Worker and Master Nodes
  hosts: k8s_cluster
  become: true
  gather_facts: false
  vars:
    kubectl_bin: /usr/local/bin/kubectl
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

  tasks:
    - name: Get current worker and master node status
      shell: "{{ kubectl_bin }} get nodes --no-headers | awk '$2 ~ /^Ready/ {c++} END{print c+0}'"
      register: ready_nodes
      changed_when: false
      failed_when: false

    - name: Check if all workers are already ready
      set_fact:
        all_ready: "{{ ready_nodes.stdout | int == groups['k8s_cluster'] | length }}"

    - name: Wait for nodes to become ready (only if not all ready)
      shell: "{{ kubectl_bin }} get nodes --no-headers | awk '$2 ~ /^Ready/ {c++} END{print c+0}'"
      register: ready_nodes
      until: ready_nodes.stdout | int == groups['k8s_cluster'] | length
      retries: 6
      delay: 5
      changed_when: false
      failed_when: false
      when: not all_ready | default(false) | bool

    - name: Get final node status
      command: "{{ kubectl_bin }} get nodes -o wide"
      register: node_status
      changed_when: false
      failed_when: false

    - name: Check if all nodes are ready
      set_fact:
        all_nodes_ready: "{{ ready_nodes.stdout | int == groups['k8s_cluster'] | length }}"
      when: ready_nodes is defined

    - name: Display final status
      debug:
        msg:
          - "========================================="
          - "Worker and master Node Fix CGroup Complete"
          - "========================================="
          - "Ready Nodes: {{ ready_nodes.stdout | default('N/A') }}/{{ groups['k8s_cluster'] | length }}"
          - "Status: {{ 'All nodes ready' if (all_nodes_ready | default(false)) else 'Some nodes may not be ready yet' }}"
          - ""
          - "Node Status:"
          - "{{ node_status.stdout_lines | default(['Unable to get node status']) }}"
          - "========================================="
      when: ready_nodes is defined or node_status is defined
