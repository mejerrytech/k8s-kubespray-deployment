---
# ==============================================================================
# PRE-CLEANUP VERIFICATION
# ==============================================================================
- name: Pre-Cleanup Verification
  hosts: all
  become: true
  gather_facts: true
  
  tasks:
    - name: Display pre-cleanup header
      debug:
        msg:
          - "========================================="
          - "PRE-CLEANUP VERIFICATION"
          - "========================================="
          - "Checking current state of {{ inventory_hostname }}"
      run_once: false

    - name: Check for running Kubernetes processes
      shell: ps aux | grep -E 'kube|etcd' | grep -v grep | wc -l
      register: pre_k8s_processes
      failed_when: false
      changed_when: false

    - name: Check for existing Kubernetes directories
      stat:
        path: "{{ item }}"
      register: pre_k8s_dirs
      loop:
        - /etc/kubernetes
        - /var/lib/kubelet
        - /var/lib/etcd
      failed_when: false

    - name: Check if critical ports are in use
      shell: netstat -tuln | grep -E ':(6443|10250|2379|2380|10251|10252)' | wc -l
      register: pre_ports_in_use
      failed_when: false
      changed_when: false

    - name: Display pre-cleanup findings
      debug:
        msg:
          - "Node: {{ inventory_hostname }}"
          - "K8s processes running: {{ pre_k8s_processes.stdout }}"
          - "K8s directories exist: {{ pre_k8s_dirs.results | selectattr('stat.exists') | list | length }}"
          - "Critical ports in use: {{ pre_ports_in_use.stdout }}"
          - "Status: {{ 'K8s installed' if (pre_k8s_processes.stdout | int > 0) else 'Already clean' }}"

# ==============================================================================
# MAIN CLEANUP
# ==============================================================================
- name: Clean up existing Kubernetes cluster
  hosts: all
  become: true
  gather_facts: false
  
  tasks:
    - name: Display cleanup warning
      debug:
        msg:
          - "========================================="
          - "KUBERNETES CLUSTER CLEANUP"
          - "========================================="
          - "This will completely remove Kubernetes from {{ inventory_hostname }}"
      run_once: false

    - name: Force kill all running containers
      shell: |
        crictl stop $(crictl ps -q) 2>/dev/null || true
        crictl rm $(crictl ps -aq) 2>/dev/null || true
        sleep 2
      ignore_errors: yes

    - name: Stop all Kubernetes and container services
      systemd:
        name: "{{ item }}"
        state: stopped
      loop:
        - kubelet
        - kube-apiserver
        - kube-controller-manager
        - kube-scheduler
        - etcd
        - containerd
        - docker
      ignore_errors: yes

    - name: Reset kubeadm on nodes
      shell: |
        kubeadm reset -f --ignore-preflight-errors=all
      ignore_errors: yes

    - name: Find all kubelet mounts
      shell: mount | grep '/var/lib/kubelet' | awk '{print $3}'
      register: kubelet_mounts
      changed_when: false
      failed_when: false

    - name: Unmount kubelet volumes
      shell: |
        for mount_point in {{ kubelet_mounts.stdout_lines | join(' ') }}; do
          umount -f "$mount_point" 2>/dev/null || true
        done
      when: kubelet_mounts.stdout_lines | length > 0
      ignore_errors: yes

    - name: Kill any remaining processes
      shell: |
        pkill -9 kube || true
        pkill -9 etcd || true
        pkill -9 containerd-shim || true
        sleep 2
      ignore_errors: yes

    - name: Remove Kubernetes directories forcefully
      shell: |
        rm -rf /etc/kubernetes || true
        rm -rf /var/lib/kubelet || true
        rm -rf /var/lib/etcd || true
        rm -rf /var/lib/containerd || true
        rm -rf /etc/cni || true
        rm -rf /var/lib/cni || true
        rm -rf /opt/cni || true
        rm -rf /run/containerd || true
        rm -rf /var/lib/docker || true
        rm -rf /var/run/kubernetes || true
        rm -rf /tmp/k8s-* || true
        rm -rf /tmp/kubespray_cache || true
        rm -rf /etc/systemd/system/kubelet.service.d || true
      ignore_errors: yes

    - name: Remove Kubernetes binaries
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /usr/local/bin/kubectl
        - /usr/local/bin/kubeadm
        - /usr/local/bin/kubelet
        - /usr/local/bin/kube-proxy
        - /usr/local/bin/etcd
        - /usr/local/bin/etcdctl
      ignore_errors: yes

    - name: Remove kubelet systemd service files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/systemd/system/kubelet.service
        - /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
      ignore_errors: yes

    - name: Remove CNI network interfaces
      shell: |
        for iface in $(ip link show | grep -E 'cali|flannel|cni' | awk -F: '{print $2}' | tr -d ' '); do
          ip link delete $iface 2>/dev/null || true
        done
      ignore_errors: yes

    - name: Clean iptables rules
      shell: |
        iptables -F && iptables -t nat -F && iptables -t mangle -F && iptables -X
      ignore_errors: yes

    - name: Clean ipvsadm rules
      shell: |
        ipvsadm --clear
      ignore_errors: yes
      when: ansible_os_family == "RedHat" or ansible_os_family == "Debian"

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Start containerd service
      systemd:
        name: containerd
        state: started
        enabled: yes
      ignore_errors: yes

    - name: Wait for containerd to stabilize
      pause:
        seconds: 5

    - name: Print cleanup status
      debug:
        msg: "Node {{ inventory_hostname }} cleanup completed"

# ==============================================================================
# POST-CLEANUP VERIFICATION
# ==============================================================================
- name: Post-Cleanup Verification
  hosts: all
  become: true
  gather_facts: true
  
  tasks:
    - name: Display post-cleanup header
      debug:
        msg:
          - "========================================="
          - "POST-CLEANUP VERIFICATION"
          - "========================================="
          - "Verifying cleanup on {{ inventory_hostname }}"
      run_once: false

    - name: Check for remaining Kubernetes processes
      shell: ps aux | grep -E 'kube|etcd' | grep -v grep
      register: post_k8s_processes
      failed_when: false
      changed_when: false

    - name: Check if Kubernetes directories still exist
      stat:
        path: "{{ item }}"
      register: post_k8s_dirs
      loop:
        - /etc/kubernetes
        - /var/lib/kubelet
        - /var/lib/etcd
        - /etc/cni
      failed_when: false

    - name: Check if Kubernetes binaries still exist
      stat:
        path: "{{ item }}"
      register: post_k8s_bins
      loop:
        - /usr/local/bin/kubectl
        - /usr/local/bin/kubeadm
        - /usr/local/bin/kubelet
      failed_when: false

    - name: Check if critical ports are now free
      wait_for:
        port: "{{ item }}"
        state: stopped
        timeout: 2
      loop:
        - 6443
        - 10250
        - 2379
        - 2380
      register: post_port_check
      failed_when: false
      ignore_errors: yes

    - name: Verify containerd is running
      systemd:
        name: containerd
      register: containerd_status
      failed_when: false

    - name: Calculate cleanup success
      set_fact:
        processes_clean: "{{ post_k8s_processes.stdout | default('') == '' }}"
        dirs_clean: "{{ post_k8s_dirs.results | selectattr('stat.exists') | list | length == 0 }}"
        bins_clean: "{{ post_k8s_bins.results | selectattr('stat.exists') | list | length == 0 }}"
        containerd_running: "{{ containerd_status.status is defined and containerd_status.status.ActiveState | default('') == 'active' }}"
        node_ready: "{{ (post_k8s_processes.stdout | default('') == '') and (post_k8s_dirs.results | selectattr('stat.exists') | list | length == 0) }}"

    - name: Display verification results
      debug:
        msg:
          - "{{ '✅' if node_ready else '❌' }} Node: {{ inventory_hostname }}"
          - "  K8s processes: {{ '✅ None running' if processes_clean else '❌ Still running' }}"
          - "  K8s directories: {{ '✅ All removed' if dirs_clean else '❌ Some remain' }}"
          - "  K8s binaries: {{ '✅ All removed' if bins_clean else '❌ Some remain' }}"
          - "  Containerd: {{ '✅ Running' if containerd_running else '❌ Not running' }}"
          - "  Status: {{ '✅ READY FOR DEPLOYMENT' if node_ready else '⚠️ CLEANUP INCOMPLETE' }}"

    # - name: Fail playbook if cleanup incomplete
    #   fail:
    #     msg: "Cleanup incomplete on {{ inventory_hostname }} - manual intervention required"
    #   when: not node_ready

# ==============================================================================
# FINAL SUMMARY
# ==============================================================================
- name: Cleanup Summary
  hosts: localhost
  gather_facts: false
  
  tasks:
    - name: Display final summary
      debug:
        msg:
          - "========================================="
          - "CLEANUP VERIFICATION COMPLETE"
          - "========================================="
          - "Review each node's status above"
          - "All nodes should show: ✅ READY FOR DEPLOYMENT"
          - ""
          - "If any node shows ⚠️ CLEANUP INCOMPLETE:"
          - "  1. Review the specific failures above"
          - "  2. Manually verify the node"
          - "  3. Re-run cleanup if needed"
          - "========================================="