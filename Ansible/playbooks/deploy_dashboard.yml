---
# ==============================================================================
# KUBERNETES DASHBOARD DEPLOYMENT AND ADMIN SETUP
# ==============================================================================
# This playbook:
# 1. Verifies dashboard is deployed by Kubespray
# 2. Creates admin service account for dashboard access
# 3. Retrieves the admin token for login
# 4. Displays access instructions
# ==============================================================================

- name: Deploy and Configure Kubernetes Dashboard
  hosts: kube_control_plane[0]  # Run on first master only
  become: yes
  gather_facts: yes
  
  vars:
    dashboard_namespace: "kubernetes-dashboard"
    admin_user: "admin-user"
    kubeconfig: "/etc/kubernetes/admin.conf"
  
  tasks:
    # ===== VERIFY DASHBOARD DEPLOYMENT =====
    - name: Check if dashboard namespace exists
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} get namespace {{ dashboard_namespace }}
      register: dashboard_ns_check
      changed_when: false
      failed_when: false
    
    - name: Wait for dashboard pods to be ready
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} wait --for=condition=ready pod \
          -l k8s-app=kubernetes-dashboard \
          -n {{ dashboard_namespace }} \
          --timeout=300s
      register: dashboard_ready
      changed_when: false
      when: dashboard_ns_check.rc == 0
    
    # ===== CREATE ADMIN SERVICE ACCOUNT =====
    - name: Create dashboard admin service account
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} create serviceaccount {{ admin_user }} \
          -n {{ dashboard_namespace }}
      register: sa_create
      changed_when: "'created' in sa_create.stdout"
      failed_when: "sa_create.rc != 0 and 'already exists' not in sa_create.stderr"
    
    # ===== CREATE CLUSTER ROLE BINDING =====
    - name: Create cluster admin role binding for dashboard user
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} create clusterrolebinding {{ admin_user }} \
          --clusterrole=cluster-admin \
          --serviceaccount={{ dashboard_namespace }}:{{ admin_user }}
      register: crb_create
      changed_when: "'created' in crb_create.stdout"
      failed_when: "crb_create.rc != 0 and 'already exists' not in crb_create.stderr"
    
    # ===== CREATE SECRET FOR TOKEN (K8s 1.24+) =====
    - name: Create secret for service account token
      shell: |
        cat <<EOF | kubectl --kubeconfig={{ kubeconfig }} apply -f -
        apiVersion: v1
        kind: Secret
        metadata:
          name: {{ admin_user }}-token
          namespace: {{ dashboard_namespace }}
          annotations:
            kubernetes.io/service-account.name: {{ admin_user }}
        type: kubernetes.io/service-account-token
        EOF
      register: secret_create
      changed_when: "'created' in secret_create.stdout or 'configured' in secret_create.stdout"
    
    # ===== WAIT FOR TOKEN TO BE CREATED =====
    - name: Wait for token to be populated
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} get secret {{ admin_user }}-token \
          -n {{ dashboard_namespace }} \
          -o jsonpath='{.data.token}'
      register: token_check
      until: token_check.stdout != ""
      retries: 10
      delay: 2
      changed_when: false
    
    # ===== GET DASHBOARD TOKEN =====
    - name: Get dashboard admin token
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} get secret {{ admin_user }}-token \
          -n {{ dashboard_namespace }} \
          -o jsonpath='{.data.token}' | base64 -d
      register: dashboard_token
      changed_when: false
    
    # ===== GET DASHBOARD SERVICE INFO =====
    - name: Get dashboard service details
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} get svc kubernetes-dashboard \
          -n {{ dashboard_namespace }} \
          -o jsonpath='{.spec.ports[0].nodePort}'
      register: dashboard_nodeport
      changed_when: false
      failed_when: false
    
    - name: Get dashboard service type
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} get svc kubernetes-dashboard \
          -n {{ dashboard_namespace }} \
          -o jsonpath='{.spec.type}'
      register: dashboard_svc_type
      changed_when: false
    
    # ===== SAVE TOKEN TO FILE =====
    - name: Save dashboard token to file
      copy:
        content: "{{ dashboard_token.stdout }}"
        dest: "/root/dashboard-admin-token.txt"
        mode: '0600'
    
    - name: Create dashboard access instructions file
      copy:
        content: |
          ================================================================================
          KUBERNETES DASHBOARD ACCESS INSTRUCTIONS
          ================================================================================
          
          Dashboard Admin Token:
          {{ dashboard_token.stdout }}
          
          Access Methods:
          
          1. VIA KUBECTL PROXY (Recommended for remote access):
             
             # On your local machine with kubectl configured:
             kubectl proxy
             
             # Then access dashboard at:
             http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/
          
          2. VIA NODEPORT (Direct access):
             {% if dashboard_svc_type.stdout == 'NodePort' %}
             https://{{ network.api_vip }}:{{ dashboard_nodeport.stdout }}
             https://{{ ansible_default_ipv4.address }}:{{ dashboard_nodeport.stdout }}
             {% else %}
             Service type is {{ dashboard_svc_type.stdout }}
             You need to use kubectl proxy method
             {% endif %}
          
          3. VIA API SERVER PROXY:
             https://{{ network.api_vip }}:6443/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/
             
             Note: Requires valid kubeconfig authentication
          
          Login Steps:
          1. Open dashboard URL in browser
          2. Select "Token" authentication method
          3. Paste the token shown above
          4. Click "Sign In"
          
          Token Location:
          - Saved to: /root/dashboard-admin-token.txt on {{ inventory_hostname }}
          
          Security Notes:
          - This token has cluster-admin privileges
          - Keep it secure and don't share publicly
          - For production, create role-specific service accounts
          - Consider implementing OIDC authentication for production use
          
          Troubleshooting:
          - If dashboard not accessible, check: kubectl get pods -n kubernetes-dashboard
          - View logs: kubectl logs -n kubernetes-dashboard <pod-name>
          - Check service: kubectl get svc -n kubernetes-dashboard
          
          ================================================================================
        dest: "/root/dashboard-access-instructions.txt"
        mode: '0644'
    
    # ===== DISPLAY ACCESS INFORMATION =====
    - name: Display dashboard access information
      debug:
        msg: |
          ================================================================================
          ‚úÖ KUBERNETES DASHBOARD SETUP COMPLETE
          ================================================================================
          
          üìã Admin Token (copy this):
          {{ dashboard_token.stdout }}
          
          üåê Access URLs:
          {% if dashboard_svc_type.stdout == 'NodePort' %}
          - NodePort: https://{{ network.api_vip }}:{{ dashboard_nodeport.stdout }}
          {% endif %}
          - kubectl proxy: http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/
          
          üìÅ Token saved to: /root/dashboard-admin-token.txt
          üìñ Full instructions: /root/dashboard-access-instructions.txt
          
          üöÄ Quick Start:
          1. Run: kubectl proxy
          2. Open browser to: http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/
          3. Select "Token" and paste the token above
          
          ================================================================================