---
# ==============================================================================
# MAINTENANCE SETUP PLAYBOOK
# ==============================================================================
# This playbook sets up maintenance tasks like etcd defragmentation
# Based on configuration in vars.yml
# ==============================================================================

- name: Setup Maintenance Scripts and Cron Jobs
  hosts: kube_control_plane[0]
  become: true
  gather_facts: true
  vars:
    services_config: "{{ services | default({}) }}"
    maintenance_enabled: "{{ services_config.setup_maintenance | default(false) }}"
    backup_path: "{{ backup.backup_path | default('/opt/backups/k8s') }}"
    
    # Maintenance schedules (can be overridden in vars.yml)
    etcd_defrag_schedule: "{{ maintenance.etcd_defrag_schedule | default('0 1 * * 0') }}"

  tasks:
    # Set Kubespray paths from inventory or use defaults (avoid recursive loops)
    - name: Set Kubespray paths
      set_fact:
        etcd_cert_dir: "{{ etcd_cert_dir | default('/etc/ssl/etcd/ssl') }}"
        etcd_access_addresses: "{{ etcd_access_addresses | default('https://127.0.0.1:2379') }}"
        bin_dir: "{{ bin_dir | default('/usr/local/bin') }}"
    - name: Check if maintenance is enabled
      debug:
        msg: "Maintenance setup skipped - services.setup_maintenance is false"
      when: not maintenance_enabled
      changed_when: false

    - name: Display maintenance configuration
      debug:
        msg:
          - "Maintenance enabled: {{ maintenance_enabled }}"
          - "ETCD defrag schedule: {{ etcd_defrag_schedule }}"
      when: maintenance_enabled

    - name: Create maintenance scripts directory
      file:
        path: "{{ backup_path }}/scripts"
        state: directory
        mode: '0755'
        owner: root
        group: root
      when: maintenance_enabled

    - name: Deploy etcd defragmentation script
      template:
        src: ../templates/defrag-etcd.sh.j2
        dest: "{{ backup_path }}/scripts/defrag-etcd.sh"
        mode: '0755'
        owner: root
        group: root
      when: maintenance_enabled
      vars:
        etcd_endpoints: "{{ etcd_access_addresses.split(',') | first }}"

    - name: Setup etcd defragmentation cron job
      cron:
        name: "ETCD Defragmentation"
        minute: "{{ etcd_defrag_schedule.split()[0] }}"
        hour: "{{ etcd_defrag_schedule.split()[1] }}"
        day: "{{ etcd_defrag_schedule.split()[2] }}"
        month: "{{ etcd_defrag_schedule.split()[3] }}"
        weekday: "{{ etcd_defrag_schedule.split()[4] | default('*') }}"
        job: "{{ backup_path }}/scripts/defrag-etcd.sh > /dev/null 2>&1"
        user: root
        state: present
      when: maintenance_enabled

    - name: Display maintenance setup summary
      debug:
        msg:
          - "âœ… Maintenance setup completed"
          - "ETCD defragmentation: Enabled"
          - "Defrag schedule: {{ etcd_defrag_schedule }}"
          - "Script location: {{ backup_path }}/scripts/defrag-etcd.sh"
      when: maintenance_enabled

