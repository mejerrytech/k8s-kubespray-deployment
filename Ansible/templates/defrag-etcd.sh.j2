#!/bin/bash
#
# ETCD Defragmentation Script for Kubespray
# Generated automatically - do not edit manually
# {{ ansible_managed }}
#
# Cron example: {{ etcd_defrag_schedule }} {{ backup_path }}/scripts/defrag-etcd.sh > /dev/null 2>&1

set -euo pipefail

# Configuration
ETCDCTL_API=3
ETCD_ENDPOINTS="{{ etcd_endpoints }}"

# Kubespray paths
ETCDCTL_BIN="{{ bin_dir }}/etcdctl"
ETCD_CERT_DIR="{{ etcd_cert_dir }}"

# TLS certificates
ETCD_CA="${ETCD_CERT_DIR}/ca.pem"
ETCD_CERT="${ETCD_CERT_DIR}/admin-$(hostname).pem"
ETCD_KEY="${ETCD_CERT_DIR}/admin-$(hostname)-key.pem"

# Check if etcdctl exists
if [ ! -f "$ETCDCTL_BIN" ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: etcdctl not found at $ETCDCTL_BIN"
    exit 1
fi

# Check if certificates exist
if [ ! -f "$ETCD_CA" ] || [ ! -f "$ETCD_CERT" ] || [ ! -f "$ETCD_KEY" ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: ETCD certificates not found"
    echo "  CA: $ETCD_CA"
    echo "  Cert: $ETCD_CERT"
    echo "  Key: $ETCD_KEY"
    exit 1
fi

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting etcd defragmentation on $ETCD_ENDPOINTS"

# Perform defragmentation
export ETCDCTL_API=$ETCDCTL_API
export ETCDCTL_ENDPOINTS="$ETCD_ENDPOINTS"
export ETCDCTL_CERT="$ETCD_CERT"
export ETCDCTL_KEY="$ETCD_KEY"
export ETCDCTL_CACERT="$ETCD_CA"

"$ETCDCTL_BIN" defrag

if [ $? -eq 0 ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ETCD defragmentation completed successfully"
    exit 0
else
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: ETCD defragmentation failed"
    exit 1
fi

